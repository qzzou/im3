<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Learning Hub</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #eee;
            display: flex;
            flex-direction: column;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* Space for tab bar */
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 1.8em;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        .header .course-name {
            color: #00ff88;
            font-size: 1.1em;
        }
        .header .subtitle {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Progress bar */
        .progress-container {
            margin: 15px 0;
        }
        .progress-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        .progress-text {
            text-align: center;
            color: #888;
            font-size: 0.85em;
            margin-top: 5px;
        }

        /* Tab content areas */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Bottom Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(20, 20, 40, 0.98);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 20px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 10px;
        }
        .tab-item:hover {
            color: #aaa;
        }
        .tab-item.active {
            color: #00d4ff;
        }
        .tab-item .icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }
        .tab-item .label {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Review Tab Styles */
        .unit-nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .unit-btn {
            background: rgba(255,255,255,0.08);
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .unit-btn:hover {
            background: rgba(0,212,255,0.15);
            border-color: #00d4ff;
        }
        .unit-btn.active {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
        }
        .unit-btn h3 {
            color: #00d4ff;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .unit-btn p {
            color: #888;
            font-size: 0.75em;
        }

        .lesson-content {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            display: none;
        }
        .lesson-content.active {
            display: block;
        }
        .lesson-content h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(0,212,255,0.3);
            padding-bottom: 10px;
        }

        .lesson {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .lesson h3 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .lesson p, .lesson li {
            line-height: 1.7;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .lesson ul {
            padding-left: 20px;
        }

        .formula-box {
            background: rgba(0,212,255,0.1);
            border-left: 4px solid #00d4ff;
            padding: 12px 15px;
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }

        .example {
            background: rgba(0,255,136,0.08);
            border-radius: 10px;
            padding: 15px;
            margin: 12px 0;
        }
        .example h4 {
            color: #00ff88;
            margin-bottom: 8px;
            font-size: 1em;
        }
        .example .solution {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed rgba(255,255,255,0.2);
        }

        /* Practice Tab Styles */
        .exercise {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #00d4ff;
        }
        .exercise.hard {
            border-left-color: #ff5555;
        }
        .exercise .question {
            font-size: 1.1em;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .exercise .unit-tag {
            display: inline-block;
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            margin-bottom: 10px;
        }

        .answer-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .answer-input input {
            flex: 1;
            min-width: 180px;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1em;
        }
        .answer-input input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-check {
            background: #00d4ff;
            color: #000;
        }
        .btn-check:hover {
            background: #00a8cc;
        }
        .btn-hint {
            background: rgba(255,170,0,0.3);
            color: #ffaa00;
        }
        .btn-hint:hover {
            background: rgba(255,170,0,0.5);
        }
        .btn-solution {
            background: rgba(0,255,136,0.3);
            color: #00ff88;
        }
        .btn-solution:hover {
            background: rgba(0,255,136,0.5);
        }
        .btn-generate {
            background: linear-gradient(135deg, #aa00ff, #00d4ff);
            color: #fff;
            padding: 12px 25px;
            margin: 20px auto;
            display: block;
        }
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(170, 0, 255, 0.4);
        }

        .feedback {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            display: none;
        }
        .feedback.correct {
            display: block;
            background: rgba(0,255,136,0.2);
            color: #00ff88;
        }
        .feedback.incorrect {
            display: block;
            background: rgba(255,85,85,0.2);
            color: #ff5555;
        }

        .hint-box, .solution-box {
            margin-top: 10px;
            padding: 12px;
            border-radius: 8px;
            display: none;
            font-size: 0.95em;
        }
        .hint-box {
            background: rgba(255,170,0,0.15);
            border-left: 3px solid #ffaa00;
        }
        .solution-box {
            background: rgba(0,255,136,0.1);
            border-left: 3px solid #00ff88;
        }
        .hint-box.show, .solution-box.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bookmark button */
        .btn-heart {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            padding: 5px;
            color: #888;
            transition: all 0.2s ease;
        }
        .btn-heart:hover {
            color: #aaa;
        }
        .btn-heart.active {
            color: #ff6b6b;
        }

        /* Export section */
        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }
        .export-section h3 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-export {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
            padding: 10px 15px;
            border: 1px solid rgba(0,212,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .btn-export:hover {
            background: rgba(0,212,255,0.3);
            border-color: #00d4ff;
        }
        .unit-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .unit-export-row:last-child {
            border-bottom: none;
        }
        .unit-export-row span {
            color: #ccc;
        }
        .btn-pdf-small {
            background: rgba(255,100,100,0.2);
            color: #ff6b6b;
            padding: 6px 12px;
            border: 1px solid rgba(255,100,100,0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }
        .btn-pdf-small:hover {
            background: rgba(255,100,100,0.3);
            border-color: #ff6b6b;
        }

        /* Print styles */
        @media print {
            body { background: white; color: black; }
            .tab-bar, .score-display, .btn, .answer-input, .filter-bar, .header, .btn-heart { display: none !important; }
            .main-content { padding: 0; padding-bottom: 0; }
            .exercise { border: 1px solid #ccc; margin-bottom: 15px; page-break-inside: avoid; }
            .exercise.hard { border-left: 4px solid #ff5555; }
            .hint-box, .solution-box, .feedback { display: none !important; }
            .unit-tag { background: #eee !important; color: #333 !important; }
            .page-break { page-break-before: always; }
            .print-header { display: block !important; font-size: 1.5em; font-weight: bold; margin-bottom: 20px; }
            .answer-key-section { display: block !important; }
        }

        /* Courses Tab Styles */
        .course-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .course-item {
            background: rgba(255,255,255,0.08);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .course-item:hover {
            background: rgba(0,212,255,0.15);
            border-color: #00d4ff;
        }
        .course-item.current {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
        }
        .course-item h3 {
            color: #00d4ff;
            margin-bottom: 5px;
        }
        .course-item p {
            color: #888;
            font-size: 0.9em;
        }
        .course-item .status {
            margin-top: 10px;
            font-size: 0.85em;
        }
        .course-item .status .progress-mini {
            background: rgba(255,255,255,0.1);
            height: 6px;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        .course-item .status .progress-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            border-radius: 3px;
        }

        /* Settings Tab Styles */
        .settings-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .settings-section h3 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-item label {
            color: #ccc;
        }
        .toggle {
            width: 50px;
            height: 26px;
            background: rgba(255,255,255,0.2);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .toggle.on {
            background: #00d4ff;
        }
        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }
        .toggle.on::after {
            left: 26px;
        }
        .btn-reset {
            background: rgba(255,85,85,0.3);
            color: #ff5555;
            width: 100%;
            margin-top: 10px;
        }
        .btn-reset:hover {
            background: rgba(255,85,85,0.5);
        }

        /* Score display */
        .score-display {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #00d4ff;
            font-size: 0.9em;
            z-index: 100;
        }
        .score-display span {
            color: #00ff88;
            font-weight: bold;
        }

        /* Filter buttons */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 20px;
            color: #aaa;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }
        .filter-btn:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        .filter-btn.active {
            background: #00d4ff;
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Load utility functions first -->
    <script>
        // Utility functions for generators
        function randInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function randChoice(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }
        // Unit registration system
        const courseUnits = { im3: {}, 'sat-math': {} };
        function registerUnit(courseId, unitData) {
            if (!courseUnits[courseId]) courseUnits[courseId] = {};
            courseUnits[courseId][unitData.id] = unitData;
        }
    </script>
    <!-- Load IM3 unit files -->
    <script src="courses/im3/unit1-polynomials.js"></script>
    <script src="courses/im3/unit2-rational.js"></script>
    <script src="courses/im3/unit3-radical.js"></script>
    <script src="courses/im3/unit4-exponentials.js"></script>
    <script src="courses/im3/unit5-trig.js"></script>
    <script src="courses/im3/unit6-trig-identities.js"></script>
    <script src="courses/im3/unit7-statistics.js"></script>
    <script src="courses/im3/unit8-sequences.js"></script>
    <!-- Load SAT Math unit files -->
    <script src="courses/sat-math/unit1-heart-of-algebra.js"></script>
    <script src="courses/sat-math/unit2-problem-solving.js"></script>
    <script src="courses/sat-math/unit3-advanced-math.js"></script>
    <script src="courses/sat-math/unit4-geometry-trig.js"></script>
    <div class="main-content" id="mainContent">
        <!-- Score Display -->
        <div class="score-display">
            Score: <span id="totalScore">0</span> pts
        </div>

        <!-- REVIEW TAB -->
        <div class="tab-content active" id="reviewTab">
            <div class="header">
                <h1 id="currentCourseName">IM3 - Integrated Math 3</h1>
                <div class="subtitle">Review</div>
            </div>

            <div class="unit-nav" id="unitNav">
                <!-- Units will be populated by JavaScript -->
            </div>

            <div id="lessonContainer">
                <!-- Lesson content will be populated by JavaScript -->
            </div>
        </div>

        <!-- PRACTICES TAB -->
        <div class="tab-content" id="practicesTab">
            <div class="header">
                <h1 id="practiceCourseName">IM3 - Integrated Math 3</h1>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="practiceProgress"></div>
                    </div>
                    <div class="progress-text"><span id="practiceProgressText">0</span>% Complete</div>
                </div>
            </div>

            <div class="filter-bar" id="filterBar">
                <!-- Filter buttons will be populated by JavaScript -->
            </div>

            <div id="exerciseContainer">
                <!-- Exercises will be populated by JavaScript -->
            </div>

            <button class="btn btn-generate" id="generateBtn">
                Generate More Problems
            </button>
        </div>

        <!-- SAVED TAB -->
        <div class="tab-content" id="favoritesTab">
            <div class="header">
                <h1 id="favCourseName">IM3 - Integrated Math 3</h1>
                <div class="subtitle">Saved</div>
            </div>

            <div id="favoritesContainer">
                <p style="color:#888; text-align:center; padding: 40px;">No saved problems yet. Click ‚òÜ on any problem to save it here.</p>
            </div>
        </div>

        <!-- COURSES TAB -->
        <div class="tab-content" id="coursesTab">
            <div class="header">
                <h1>My Courses</h1>
                <div class="subtitle">Select a course to continue learning</div>
            </div>

            <div class="course-list" id="courseList">
                <!-- Courses will be populated by JavaScript -->
            </div>

            <div class="export-section">
                <h3>Export</h3>
                <div class="export-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-export" onclick="exportToJSON()">Export Course to JSON</button>
                </div>
                <h4 style="color: #ccc; margin-bottom: 10px; font-size: 0.95em;">Print to PDF by Unit</h4>
                <div id="unitExportList">
                    <!-- Unit PDF buttons populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-content" id="settingsTab">
            <div class="header">
                <h1>Settings</h1>
            </div>

            <div class="settings-section">
                <h3>Display</h3>
                <div class="setting-item">
                    <label>Show Hints by Default</label>
                    <div class="toggle" id="toggleHints" onclick="toggleSetting('showHints')"></div>
                </div>
                <div class="setting-item">
                    <label>Sound Effects</label>
                    <div class="toggle on" id="toggleSound" onclick="toggleSetting('soundOn')"></div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Progress</h3>
                <div class="setting-item">
                    <label>Total Score</label>
                    <span id="settingsScore">0 pts</span>
                </div>
                <div class="setting-item">
                    <label>Problems Completed</label>
                    <span id="settingsCompleted">0</span>
                </div>
                <button class="btn btn-reset" onclick="resetProgress()">Reset All Progress</button>
            </div>

            <div class="settings-section">
                <h3>About</h3>
                <div class="setting-item">
                    <label>Version</label>
                    <span>1.0.0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Tab Bar -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('review')">
            <div class="icon">üìö</div>
            <div class="label">Review</div>
        </div>
        <div class="tab-item" onclick="switchTab('practices')">
            <div class="icon">‚úèÔ∏è</div>
            <div class="label">Practices</div>
        </div>
        <div class="tab-item" onclick="switchTab('favorites')">
            <div class="icon">‚òÖ</div>
            <div class="label">Saved</div>
        </div>
        <div class="tab-item" onclick="switchTab('courses')">
            <div class="icon">üìñ</div>
            <div class="label">Courses</div>
        </div>
        <div class="tab-item" onclick="switchTab('settings')">
            <div class="icon">‚öôÔ∏è</div>
            <div class="label">Settings</div>
        </div>
    </div>

    <script>
        // ============================================
        // APP STATE & DATA
        // ============================================

        const appState = {
            currentCourse: 'im3',
            currentTab: 'review',
            currentUnit: 1,
            score: 0,
            completedProblems: new Set(),
            favorites: new Set(), // saved problems
            generatedProblems: [], // persisted generated problems
            settings: {
                showHints: false,
                soundOn: true
            },
            bookmarks: {} // courseId -> { tab, unit, scrollPos }
        };

        // Course definitions
        const courses = {
            im3: {
                id: 'im3',
                name: 'IM3 - Integrated Math 3',
                description: 'Polynomials, Rational Functions, Trigonometry, and more',
                units: [
                    { id: 1, name: 'Unit 1', title: 'Polynomials & Polynomial Functions' },
                    { id: 2, name: 'Unit 2', title: 'Rational Functions & Expressions' },
                    { id: 3, name: 'Unit 3', title: 'Radical Functions & Equations' },
                    { id: 4, name: 'Unit 4', title: 'Exponentials & Logarithms' },
                    { id: 5, name: 'Unit 5', title: 'Trigonometry & Unit Circle' },
                    { id: 6, name: 'Unit 6', title: 'Trig Identities & Equations' },
                    { id: 7, name: 'Unit 7', title: 'Statistics & Probability' },
                    { id: 8, name: 'Unit 8', title: 'Sequences & Series' }
                ],
                progress: 0
            },
            algebra2: {
                id: 'algebra2',
                name: 'Algebra 2',
                description: 'Quadratics, Complex Numbers, Polynomials',
                units: [
                    { id: 1, name: 'Unit 1', title: 'Equations & Inequalities' },
                    { id: 2, name: 'Unit 2', title: 'Linear Functions' },
                    { id: 3, name: 'Unit 3', title: 'Quadratic Functions' },
                    { id: 4, name: 'Unit 4', title: 'Polynomial Functions' }
                ],
                progress: 0
            },
            precalc: {
                id: 'precalc',
                name: 'Pre-Calculus',
                description: 'Functions, Trigonometry, Limits',
                units: [
                    { id: 1, name: 'Unit 1', title: 'Functions & Graphs' },
                    { id: 2, name: 'Unit 2', title: 'Polynomial & Rational Functions' },
                    { id: 3, name: 'Unit 3', title: 'Exponential & Logarithmic Functions' },
                    { id: 4, name: 'Unit 4', title: 'Trigonometric Functions' }
                ],
                progress: 0
            },
            'sat-math': {
                id: 'sat-math',
                name: 'SAT Math',
                description: 'Heart of Algebra, Problem Solving, Advanced Math, Geometry',
                units: [
                    { id: 1, name: 'Unit 1', title: 'Heart of Algebra' },
                    { id: 2, name: 'Unit 2', title: 'Problem Solving & Data Analysis' },
                    { id: 3, name: 'Unit 3', title: 'Passport to Advanced Math' },
                    { id: 4, name: 'Unit 4', title: 'Geometry & Trigonometry' }
                ],
                progress: 0
            }
        };

        // Course Content - built from loaded unit files
        const im3Content = { units: {}, exercises: [] };
        const satMathContent = { units: {}, exercises: [] };

        // Build content from loaded unit files
        function buildCourseContent() {
            // Build IM3 content
            if (courseUnits.im3) {
                for (let i = 1; i <= 8; i++) {
                    const unit = courseUnits.im3[i];
                    if (unit) {
                        im3Content.units[i] = {
                            title: unit.title,
                            lessons: unit.lessons
                        };
                        if (unit.exercises) {
                            unit.exercises.forEach(ex => {
                                if (!im3Content.exercises.find(e => e.id === ex.id)) {
                                    im3Content.exercises.push(ex);
                                }
                            });
                        }
                    }
                }
            }

            // Build SAT Math content
            if (courseUnits['sat-math']) {
                for (let i = 1; i <= 4; i++) {
                    const unit = courseUnits['sat-math'][i];
                    if (unit) {
                        satMathContent.units[i] = {
                            title: unit.title,
                            lessons: unit.lessons
                        };
                        if (unit.exercises) {
                            unit.exercises.forEach(ex => {
                                if (!satMathContent.exercises.find(e => e.id === ex.id)) {
                                    satMathContent.exercises.push(ex);
                                }
                            });
                        }
                    }
                }
            }
        }

        // Build problem generators registry from loaded units
        const problemGenerators = { im3: {}, 'sat-math': {} };
        function buildGenerators() {
            // IM3 generators
            if (courseUnits.im3) {
                for (let i = 1; i <= 8; i++) {
                    const unit = courseUnits.im3[i];
                    if (unit && unit.generators) {
                        problemGenerators.im3[i] = unit.generators;
                    }
                }
            }

            // SAT Math generators
            if (courseUnits['sat-math']) {
                for (let i = 1; i <= 4; i++) {
                    const unit = courseUnits['sat-math'][i];
                    if (unit && unit.generators) {
                        problemGenerators['sat-math'][i] = unit.generators;
                    }
                }
            }
        }

        // Helper to get current course content
        function getCurrentCourseContent() {
            if (appState.currentCourse === 'im3') return im3Content;
            if (appState.currentCourse === 'sat-math') return satMathContent;
            return { units: {}, exercises: [] };
        }

        // Content is now loaded from unit files
        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            // Build content from loaded unit files
            buildCourseContent();
            buildGenerators();

            loadState();
            renderCourseList();
            renderUnitExportList();
            loadCourse(appState.currentCourse);
            updateScoreDisplay();
            applySettings();
        }

        function loadState() {
            const saved = localStorage.getItem('mathHubState');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(appState, parsed);
                appState.completedProblems = new Set(parsed.completedProblems || []);
                appState.favorites = new Set(parsed.favorites || []);
                appState.generatedProblems = parsed.generatedProblems || [];

                // Restore generated problems to exercises array
                if (appState.generatedProblems.length > 0) {
                    appState.generatedProblems.forEach(prob => {
                        const content = prob.id.startsWith('sat') ? satMathContent : im3Content;
                        if (!content.exercises.find(ex => ex.id === prob.id)) {
                            content.exercises.push(prob);
                        }
                    });
                    generatedCount = appState.generatedProblems.length;
                }
            }
        }

        function saveState() {
            const toSave = {
                ...appState,
                completedProblems: Array.from(appState.completedProblems),
                favorites: Array.from(appState.favorites),
                generatedProblems: appState.generatedProblems
            };
            localStorage.setItem('mathHubState', JSON.stringify(toSave));
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function switchTab(tabName) {
            // Save bookmark for current course/tab
            saveBookmark();

            // Update tab bar
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Render favorites when switching to that tab
            if (tabName === 'favorites') {
                renderFavorites();
            }

            appState.currentTab = tabName;
            saveState();
        }

        // ============================================
        // COURSE MANAGEMENT
        // ============================================

        function renderCourseList() {
            const container = document.getElementById('courseList');
            container.innerHTML = '';

            Object.values(courses).forEach(course => {
                const isCurrent = course.id === appState.currentCourse;
                const div = document.createElement('div');
                div.className = 'course-item' + (isCurrent ? ' current' : '');
                div.onclick = () => selectCourse(course.id);
                div.innerHTML = `
                    <h3>${course.name}</h3>
                    <p>${course.description}</p>
                    <div class="status">
                        ${isCurrent ? '<span style="color:#00ff88;">‚óè Current Course</span>' : ''}
                        <div class="progress-mini">
                            <div class="progress-mini-fill" style="width: ${course.progress}%"></div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectCourse(courseId) {
            if (courseId === appState.currentCourse) return;

            // Save bookmark for current course
            saveBookmark();

            // Switch course
            appState.currentCourse = courseId;
            loadCourse(courseId);
            renderCourseList();
            renderUnitExportList();

            // Restore bookmark if exists
            restoreBookmark();

            saveState();
        }

        function loadCourse(courseId) {
            const course = courses[courseId];
            if (!course) return;

            // Update headers
            document.getElementById('currentCourseName').textContent = course.name;
            document.getElementById('practiceCourseName').textContent = course.name;

            // Render units
            renderUnitNav(course);

            // Render lessons - supported courses have content
            const supportedCourses = ['im3', 'sat-math'];
            if (supportedCourses.includes(courseId)) {
                renderLessons(appState.currentUnit);
                renderFilterBar();
                renderExercises(1);
            } else {
                document.getElementById('lessonContainer').innerHTML =
                    '<div class="lesson"><p style="color:#888;">Content coming soon for this course!</p></div>';
                document.getElementById('exerciseContainer').innerHTML = '';
            }
        }

        function renderUnitNav(course) {
            const container = document.getElementById('unitNav');
            container.innerHTML = '';

            course.units.forEach(unit => {
                const btn = document.createElement('div');
                btn.className = 'unit-btn' + (unit.id === appState.currentUnit ? ' active' : '');
                btn.onclick = () => selectUnit(unit.id);
                btn.innerHTML = `
                    <h3>${unit.name}</h3>
                    <p>${unit.title}</p>
                `;
                container.appendChild(btn);
            });
        }

        function selectUnit(unitId) {
            appState.currentUnit = unitId;

            // Update nav
            document.querySelectorAll('.unit-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === unitId);
            });

            // Update content
            renderLessons(unitId);
            saveState();
        }

        function renderLessons(unitId) {
            const container = document.getElementById('lessonContainer');
            const courseContent = getCurrentCourseContent();

            if (!courseContent.units[unitId]) {
                container.innerHTML = '<div class="lesson"><p style="color:#888;">Content coming soon!</p></div>';
                return;
            }

            const unit = courseContent.units[unitId];
            let html = `<div class="lesson-content active">
                <h2>${unit.title}</h2>`;

            unit.lessons.forEach(lesson => {
                html += `<div class="lesson">
                    <h3>${lesson.title}</h3>
                    ${lesson.content}
                </div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ============================================
        // BOOKMARKS
        // ============================================

        function saveBookmark() {
            appState.bookmarks[appState.currentCourse] = {
                tab: appState.currentTab,
                unit: appState.currentUnit,
                scrollPos: document.getElementById('mainContent').scrollTop
            };
        }

        function restoreBookmark() {
            const bookmark = appState.bookmarks[appState.currentCourse];
            if (bookmark) {
                appState.currentUnit = bookmark.unit;

                // Switch to bookmarked tab
                const tabItems = document.querySelectorAll('.tab-item');
                tabItems.forEach(item => item.classList.remove('active'));

                const tabIndex = ['review', 'practices', 'courses', 'settings'].indexOf(bookmark.tab);
                if (tabIndex >= 0) {
                    tabItems[tabIndex].classList.add('active');
                }

                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(bookmark.tab + 'Tab').classList.add('active');

                appState.currentTab = bookmark.tab;

                // Restore scroll position
                setTimeout(() => {
                    document.getElementById('mainContent').scrollTop = bookmark.scrollPos;
                }, 100);
            }
        }

        // ============================================
        // EXERCISES / PRACTICES
        // ============================================

        function renderFilterBar() {
            const container = document.getElementById('filterBar');
            const course = courses[appState.currentCourse];

            let html = '';
            course.units.forEach((unit, index) => {
                html += `<button class="filter-btn ${index === 0 ? 'active' : ''}" onclick="filterExercises(${unit.id})">${unit.name}</button>`;
            });

            container.innerHTML = html;
        }

        function filterExercises(unitId) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const btnUnitId = parseInt(btn.getAttribute('onclick').match(/\d+/)[0]);
                btn.classList.toggle('active', btnUnitId === unitId);
            });
            renderExercises(unitId);
        }

        function renderExercises(filterUnit = null) {
            const container = document.getElementById('exerciseContainer');
            const courseContent = getCurrentCourseContent();

            if (courseContent.exercises.length === 0) {
                container.innerHTML = '<p style="color:#888; text-align:center;">Exercises coming soon!</p>';
                return;
            }

            let exercises = courseContent.exercises;
            if (filterUnit) {
                exercises = exercises.filter(ex => ex.unit === filterUnit);
            }

            // Shuffle for variety
            exercises = [...exercises].sort(() => Math.random() - 0.5);

            let html = '';
            exercises.forEach((ex, index) => {
                const isCompleted = appState.completedProblems.has(ex.id);
                const isFavorite = appState.favorites.has(ex.id);
                html += `
                    <div class="exercise ${ex.hard ? 'hard' : ''}" id="ex-${ex.id}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span class="unit-tag">Unit ${ex.unit}</span>
                            <div>
                                ${isCompleted ? '<span style="color:#00ff88; margin-right: 10px;">‚úì Completed</span>' : ''}
                                <button class="btn-heart ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${ex.id}')" title="Add to favorites">
                                    ${isFavorite ? '‚òÖ' : '‚òÜ'}
                                </button>
                            </div>
                        </div>
                        <p class="question">${index + 1}. ${ex.question}</p>
                        <div class="answer-input">
                            <input type="text" id="ans-${ex.id}" placeholder="Enter your answer">
                            <button class="btn btn-check" onclick="checkExercise('${ex.id}')">Check</button>
                        </div>
                        <button class="btn btn-hint" onclick="toggleHintEx('${ex.id}')">Hint</button>
                        <button class="btn btn-solution" onclick="toggleSolutionEx('${ex.id}')">Solution</button>
                        <div class="hint-box" id="hint-${ex.id}">${ex.hint}</div>
                        <div class="solution-box" id="sol-${ex.id}">${ex.solution}</div>
                        <div class="feedback" id="fb-${ex.id}"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
            updateProgress();
        }

        function checkExercise(id) {
            const courseContent = getCurrentCourseContent();
            const exercise = courseContent.exercises.find(ex => ex.id === id);
            const input = document.getElementById('ans-' + id);
            const feedback = document.getElementById('fb-' + id);

            let isCorrect = false;

            if (exercise.answerType === 'zeros') {
                const userVals = input.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)).sort((a,b) => a-b);
                const correctVals = exercise.zeros.sort((a,b) => a-b);
                isCorrect = userVals.length === correctVals.length &&
                            userVals.every((v, i) => Math.abs(v - correctVals[i]) < 0.01);
            } else {
                const userAns = input.value.replace(/\s/g, '').toLowerCase();
                const correctAns = exercise.answer.replace(/\s/g, '').toLowerCase();
                isCorrect = userAns === correctAns;
            }

            if (isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = '‚úì Correct! +10 points';
                if (!appState.completedProblems.has(id)) {
                    appState.completedProblems.add(id);
                    appState.score += 10;
                    updateScoreDisplay();
                    updateProgress();
                    saveState();
                }
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = '‚úó Not quite. Check your work and try again!';
            }
        }

        function toggleHintEx(id) {
            document.getElementById('hint-' + id).classList.toggle('show');
        }

        function toggleSolutionEx(id) {
            document.getElementById('sol-' + id).classList.toggle('show');
        }

        function toggleFavorite(id) {
            const btn = document.querySelector(`#ex-${id} .btn-heart`);

            if (appState.favorites.has(id)) {
                appState.favorites.delete(id);
                if (btn) {
                    btn.classList.remove('active');
                    btn.textContent = '‚òÜ';
                }
            } else {
                appState.favorites.add(id);
                if (btn) {
                    btn.classList.add('active');
                    btn.textContent = '‚òÖ';
                }
            }

            saveState();

            // If on favorites tab, re-render
            if (appState.currentTab === 'favorites') {
                renderFavorites();
            }
        }

        function renderFavorites() {
            const container = document.getElementById('favoritesContainer');

            if (appState.favorites.size === 0) {
                container.innerHTML = '<p style="color:#888; text-align:center; padding: 40px;">No saved problems yet. Click ‚òÜ on any problem to save it here.</p>';
                return;
            }

            // Get favorites from all courses
            const allExercises = [...im3Content.exercises, ...satMathContent.exercises];
            const favoriteExercises = allExercises.filter(ex => appState.favorites.has(ex.id));

            if (favoriteExercises.length === 0) {
                container.innerHTML = '<p style="color:#888; text-align:center; padding: 40px;">No saved problems yet. Click ‚òÜ on any problem to save it here.</p>';
                return;
            }

            // Helper to determine which course an exercise belongs to
            function getExerciseCourse(exId) {
                if (im3Content.exercises.find(e => e.id === exId)) return 'IM3';
                if (satMathContent.exercises.find(e => e.id === exId)) return 'SAT';
                return '';
            }

            let html = '';
            favoriteExercises.forEach((ex, index) => {
                const isCompleted = appState.completedProblems.has(ex.id);
                const courseName = getExerciseCourse(ex.id);
                html += `
                    <div class="exercise ${ex.hard ? 'hard' : ''}" id="ex-${ex.id}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <span class="unit-tag" style="background: ${courseName === 'SAT' ? 'rgba(170,0,255,0.3)' : 'rgba(0,212,255,0.2)'}; color: ${courseName === 'SAT' ? '#aa00ff' : '#00d4ff'};">${courseName}</span>
                                <span class="unit-tag" style="margin-left: 5px;">Unit ${ex.unit}</span>
                            </div>
                            <div>
                                ${isCompleted ? '<span style="color:#00ff88; margin-right: 10px;">‚úì Completed</span>' : ''}
                                <button class="btn-heart active" onclick="toggleFavorite('${ex.id}')" title="Remove from favorites">‚òÖ</button>
                            </div>
                        </div>
                        <p class="question">${index + 1}. ${ex.question}</p>
                        <div class="answer-input">
                            <input type="text" id="fav-ans-${ex.id}" placeholder="Enter your answer">
                            <button class="btn btn-check" onclick="checkFavoriteExercise('${ex.id}')">Check</button>
                        </div>
                        <button class="btn btn-hint" onclick="toggleHintFav('${ex.id}')">Hint</button>
                        <button class="btn btn-solution" onclick="toggleSolutionFav('${ex.id}')">Solution</button>
                        <div class="hint-box" id="fav-hint-${ex.id}">${ex.hint}</div>
                        <div class="solution-box" id="fav-sol-${ex.id}">${ex.solution}</div>
                        <div class="feedback" id="fav-fb-${ex.id}"></div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleHintFav(id) {
            document.getElementById('fav-hint-' + id).classList.toggle('show');
        }

        function toggleSolutionFav(id) {
            document.getElementById('fav-sol-' + id).classList.toggle('show');
        }

        function checkFavoriteExercise(id) {
            const allExercises = [...im3Content.exercises, ...satMathContent.exercises];
            const exercise = allExercises.find(ex => ex.id === id);
            const input = document.getElementById('fav-ans-' + id);
            const feedback = document.getElementById('fav-fb-' + id);

            let isCorrect = false;

            if (exercise.answerType === 'zeros') {
                const userVals = input.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v)).sort((a,b) => a-b);
                const correctVals = exercise.zeros.sort((a,b) => a-b);
                isCorrect = userVals.length === correctVals.length &&
                            userVals.every((v, i) => Math.abs(v - correctVals[i]) < 0.01);
            } else {
                const userAns = input.value.replace(/\s/g, '').toLowerCase();
                const correctAns = exercise.answer.replace(/\s/g, '').toLowerCase();
                isCorrect = userAns === correctAns;
            }

            if (isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = '‚úì Correct! +10 points';
                if (!appState.completedProblems.has(id)) {
                    appState.completedProblems.add(id);
                    appState.score += 10;
                    updateScoreDisplay();
                    updateProgress();
                    saveState();
                }
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = '‚úó Not quite. Check your work and try again!';
            }
        }

        // ============================================
        // PROBLEM GENERATORS
        // ============================================

        let generatedCount = 0;


        function generateMoreProblems() {
            const courseId = appState.currentCourse;

            // Only IM3 has generators for now
            if (courseId !== 'im3') {
                alert('Problem generators coming soon for this course!');
                return;
            }

            const generators = problemGenerators[courseId];

            // Get current filter
            const activeFilter = document.querySelector('.filter-btn.active');
            let filterUnit = 0;
            if (activeFilter) {
                const text = activeFilter.textContent.trim();
                if (text !== 'All') {
                    filterUnit = parseInt(text.replace('Unit ', '')) || 0;
                }
            }

            // Collect available generators
            let availableGens = [];
            if (filterUnit === 0) {
                // All units - only include units with generators
                Object.keys(generators).forEach(unitKey => {
                    const unitNum = parseInt(unitKey);
                    const unitGens = generators[unitKey];
                    if (unitGens && unitGens.length > 0) {
                        unitGens.forEach(gen => {
                            availableGens.push({ gen, unit: unitNum });
                        });
                    }
                });
            } else {
                // Specific unit
                const unitGens = generators[filterUnit] || [];
                unitGens.forEach(gen => {
                    availableGens.push({ gen, unit: filterUnit });
                });
            }

            if (availableGens.length === 0) {
                alert('No problem generators available for this selection yet. Coming soon!');
                return;
            }

            // Generate 3 new problems
            const container = document.getElementById('exerciseContainer');
            if (!container) return;

            // Count existing problems in container to continue numbering
            const existingProblems = container.querySelectorAll('.exercise').length;

            const newProblemsHtml = [];

            for (let i = 0; i < 3; i++) {
                const { gen, unit } = randChoice(availableGens);
                const problem = gen();
                generatedCount++;
                const id = `gen-${generatedCount}`;
                const problemNumber = existingProblems + i + 1;

                // Create problem object
                const problemObj = {
                    id: id,
                    unit: problem.unit || unit,
                    question: problem.question,
                    answer: problem.answer,
                    answerType: problem.answerType,
                    zeros: problem.zeros,
                    hint: problem.hint,
                    solution: problem.solution,
                    hard: problem.hard,
                    generated: true
                };

                // Add to exercises array for checking
                getCurrentCourseContent().exercises.push(problemObj);

                // Also save to persistent storage
                appState.generatedProblems.push(problemObj);

                // Color coding based on difficulty
                const difficultyColors = problem.hard
                    ? { border: '#ff5555', gradient: 'linear-gradient(90deg, #ff5555, #ff8800)', label: 'Challenge' }
                    : { border: '#00d4ff', gradient: 'linear-gradient(90deg, #00d4ff, #00ff88)', label: 'Standard' };

                newProblemsHtml.push(`
                    <div class="exercise ${problem.hard ? 'hard' : ''}" id="ex-${id}" style="border-color: ${difficultyColors.border}; animation: fadeIn 0.5s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <span class="unit-tag" style="background: ${difficultyColors.gradient}; color: #fff;">Unit ${problem.unit || unit}</span>
                                <span style="font-size: 0.75em; color: ${difficultyColors.border}; margin-left: 8px;">${difficultyColors.label}</span>
                            </div>
                            <button class="btn-heart" onclick="toggleFavorite('${id}')" title="Add to favorites">‚òÜ</button>
                        </div>
                        <p class="question">${problemNumber}. ${problem.question}</p>
                        <div class="answer-input">
                            <input type="text" id="ans-${id}" placeholder="Enter your answer">
                            <button class="btn btn-check" onclick="checkExercise('${id}')">Check</button>
                        </div>
                        <button class="btn btn-hint" onclick="toggleHintEx('${id}')">Hint</button>
                        <button class="btn btn-solution" onclick="toggleSolutionEx('${id}')">Solution</button>
                        <div class="hint-box" id="hint-${id}">${problem.hint}</div>
                        <div class="solution-box" id="sol-${id}">${problem.solution}</div>
                        <div class="feedback" id="fb-${id}"></div>
                    </div>
                `);
            }

            // Append new problems to container (at the bottom)
            container.insertAdjacentHTML('beforeend', newProblemsHtml.join(''));

            // Scroll to show the new problems
            const newProblem = document.getElementById('ex-' + `gen-${generatedCount}`);
            if (newProblem) {
                newProblem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Save generated problems to localStorage
            saveState();
            updateProgress();
        }

        function updateProgress() {
            const courseContent = getCurrentCourseContent();
            const total = courseContent.exercises.length;
            if (total === 0) {
                document.getElementById('practiceProgress').style.width = '0%';
                document.getElementById('practiceProgressText').textContent = '0';
                return;
            }
            const completed = Array.from(appState.completedProblems).filter(id =>
                courseContent.exercises.some(ex => ex.id === id)
            ).length;
            const percent = Math.round((completed / total) * 100);

            document.getElementById('practiceProgress').style.width = percent + '%';
            document.getElementById('practiceProgressText').textContent = percent;

            if (courses[appState.currentCourse]) {
                courses[appState.currentCourse].progress = percent;
            }
        }

        // ============================================
        // SETTINGS
        // ============================================

        function toggleSetting(setting) {
            appState.settings[setting] = !appState.settings[setting];
            applySettings();
            saveState();
        }

        function applySettings() {
            document.getElementById('toggleHints').classList.toggle('on', appState.settings.showHints);
            document.getElementById('toggleSound').classList.toggle('on', appState.settings.soundOn);
            document.getElementById('settingsScore').textContent = appState.score + ' pts';
            document.getElementById('settingsCompleted').textContent = appState.completedProblems.size;
        }

        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                appState.score = 0;
                appState.completedProblems = new Set();
                appState.bookmarks = {};
                Object.values(courses).forEach(c => c.progress = 0);

                updateScoreDisplay();
                updateProgress();
                renderExercises(1);
                applySettings();
                saveState();
            }
        }

        function updateScoreDisplay() {
            document.getElementById('totalScore').textContent = appState.score;
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================

        function renderUnitExportList() {
            const container = document.getElementById('unitExportList');
            if (!container) return;

            const course = courses[appState.currentCourse];
            if (!course) return;

            const courseContent = getCurrentCourseContent();
            let html = '';
            course.units.forEach(unit => {
                const unitExercises = courseContent.exercises.filter(ex => ex.unit === unit.id);
                const count = unitExercises.length;
                html += `
                    <div class="unit-export-row">
                        <span>${unit.name}: ${unit.title} (${count} problems)</span>
                        <button class="btn-pdf-small" onclick="printUnitToPDF(${unit.id})">PDF</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function exportToJSON() {
            const course = courses[appState.currentCourse];
            if (!course) {
                alert('No course selected');
                return;
            }

            // Build export data
            const courseContent = getCurrentCourseContent();
            const exportData = {
                course: {
                    id: course.id,
                    name: course.name,
                    description: course.description,
                    units: course.units
                },
                exercises: courseContent.exercises.map(ex => ({
                    id: ex.id,
                    unit: ex.unit,
                    question: ex.question,
                    answer: ex.answer,
                    answerType: ex.answerType,
                    zeros: ex.zeros,
                    hint: ex.hint,
                    solution: ex.solution,
                    hard: ex.hard || false,
                    generated: ex.generated || false
                })),
                lessons: courseContent.units,
                exportDate: new Date().toISOString(),
                userProgress: {
                    score: appState.score,
                    completedProblems: Array.from(appState.completedProblems),
                    savedProblems: Array.from(appState.favorites)
                }
            };

            // Create and download file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${course.id}-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printUnitToPDF(unitId) {
            const course = courses[appState.currentCourse];
            const unit = course.units.find(u => u.id === unitId);
            if (!unit) return;

            const courseContent = getCurrentCourseContent();
            const unitExercises = courseContent.exercises.filter(ex => ex.unit === unitId);
            if (unitExercises.length === 0) {
                alert('No problems found for this unit.');
                return;
            }

            // Create print window
            const printWindow = window.open('', '_blank');

            let problemsHtml = '';
            let hintsHtml = '';
            let answerKeyHtml = '';

            unitExercises.forEach((ex, index) => {
                // Problems section (no hints)
                problemsHtml += `
                    <div class="problem" style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; ${ex.hard ? 'border-left: 4px solid #ff5555;' : ''}">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Problem ${index + 1}${ex.hard ? ' (Challenge)' : ''}</div>
                        <div style="font-size: 1.1em; line-height: 1.6;">${ex.question}</div>
                    </div>
                `;

                // Hints section
                hintsHtml += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #fff8e1; border-radius: 5px; border-left: 3px solid #ffaa00;">
                        <strong>Problem ${index + 1}:</strong> <span style="color: #666;">${ex.hint}</span>
                    </div>
                `;

                // Answer key section
                answerKeyHtml += `
                    <div class="answer" style="margin-bottom: 20px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">Problem ${index + 1}</div>
                        <div style="margin-bottom: 10px;"><strong>Answer:</strong> ${ex.answer || (ex.zeros ? ex.zeros.join(', ') : 'N/A')}</div>
                        <div style="font-size: 0.9em; line-height: 1.6;">${ex.solution}</div>
                    </div>
                `;
            });

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${course.name} - ${unit.name}: ${unit.title}</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 30px; max-width: 800px; margin: 0 auto; }
                        h1 { color: #333; border-bottom: 2px solid #00d4ff; padding-bottom: 10px; }
                        h2 { color: #555; margin-top: 30px; }
                        .page-break { page-break-before: always; }
                        @media print {
                            .no-print { display: none; }
                            body { padding: 20px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="margin-bottom: 20px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #00d4ff; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Print / Save as PDF</button>
                        <span style="margin-left: 10px; color: #666;">Click to print or save as PDF</span>
                    </div>

                    <h1>${course.name}</h1>
                    <h2>${unit.name}: ${unit.title}</h2>
                    <p style="color: #666;">${unitExercises.length} problems</p>

                    <div class="problems-section">
                        ${problemsHtml}
                    </div>

                    <div class="page-break"></div>

                    <h1>Hints</h1>
                    <h2>${unit.name}: ${unit.title}</h2>

                    <div class="hints-section">
                        ${hintsHtml}
                    </div>

                    <div class="page-break"></div>

                    <h1>Answer Key</h1>
                    <h2>${unit.name}: ${unit.title}</h2>

                    <div class="answers-section">
                        ${answerKeyHtml}
                    </div>
                <\/body>
                <\/html>
            `);
            printWindow.document.close();
        }

        // Initialize on load
        init();

        // Attach click handler
        document.getElementById('generateBtn').addEventListener('click', generateMoreProblems);
    </script>
</body>
</html>
